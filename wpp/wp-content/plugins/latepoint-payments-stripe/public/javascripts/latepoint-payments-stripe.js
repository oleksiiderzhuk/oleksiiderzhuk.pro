class LatepointPaymentsStripeAddon{constructor(e){this.stripeKey=e,this.stripeElements=null,this.stripeCore=null,this.stripePaymentMethod=null,this.stripeContinueBookingIntentURL=null,this.stripePaymentIntentSecret=null,this.stripeCardElements={cardNumber:null,cardExpiry:null,cardCvc:null},this.stripeIdealBankElement=null,this.ready()}ready(){jQuery(document).ready((()=>{jQuery("body").on("latepoint:submitBookingForm",".latepoint-booking-form-element",((e,t)=>{if(!latepoint_helper.demo_mode&&t.is_final_submit&&"next"==t.direction){switch(jQuery(e.currentTarget).find('input[name="booking[payment_method]"]').val()){case"card":latepoint_add_action(t.callbacks_list,(()=>{if(this.stripePaymentIntentSecret&&this.stripePaymentMethod&&this.stripeCore)return this.confirmCardPayment(jQuery(e.currentTarget),this.stripePaymentIntentSecret,this.stripePaymentMethod)}));break;case"ideal":latepoint_add_action(t.callbacks_list,(()=>{if(this.stripePaymentIntentSecret&&this.stripePaymentMethod&&this.stripeCore)return this.confirmIdealPayment(jQuery(e.currentTarget),this.stripePaymentIntentSecret,this.stripePaymentMethod)}))}}})),jQuery("body").on("latepoint:nextStepClicked",".latepoint-booking-form-element",((e,t)=>{if(!latepoint_helper.demo_mode&&"payment"==t.current_step){switch(jQuery(e.currentTarget).find('input[name="booking[payment_method]"]').val()){case"card":latepoint_add_action(t.callbacks_list,(()=>this.createPaymentMethod(jQuery(e.currentTarget),"card")));break;case"ideal":latepoint_add_action(t.callbacks_list,(()=>this.createPaymentMethod(jQuery(e.currentTarget),"ideal")))}}})),jQuery("body").on("latepoint:initPaymentMethod",".latepoint-booking-form-element",((e,t)=>{if(latepoint_helper.demo_mode)latepoint_show_next_btn(jQuery(e.currentTarget));else switch(t.payment_method){case"stripe_checkout":latepoint_add_action(t.callbacks_list,(()=>this.createPaymentSession(jQuery(e.currentTarget),t.payment_method)));break;case"card":case"ideal":latepoint_add_action(t.callbacks_list,(()=>this.createPaymentIntent(jQuery(e.currentTarget),t.payment_method)))}})),jQuery("body").on("latepoint:initStep:payment",".latepoint-booking-form-element",((e,t)=>{if(!latepoint_helper.demo_mode)try{this.stripeCore=Stripe(this.stripeKey),this.stripeElements=this.stripeCore.elements(),jQuery(e.currentTarget).find("#lp_ideal_bank_element").length&&this.initIdealForm(jQuery(e.currentTarget)),jQuery(e.currentTarget).find("#payment_card_number").length&&this.initCreditCardForm(jQuery(e.currentTarget))}catch(e){alert(e)}}))}))}createPaymentMethod(e,t){let r=jQuery.Deferred(),n={type:t};switch(t){case"card":n.card=this.stripeCardElements.cardNumber,n.billing_details={name:e.find('input[name="payment[name_on_card]"]').val()},latepoint_helper.is_stripe_zip_code_removed||(n.billing_details.address={postal_code:e.find('input[name="payment[zip]"]').val()});break;case"ideal":n.ideal=this.stripeIdealBankElement}return this.stripeCore.createPaymentMethod(n).then((e=>{e.error?r.reject({message:e.error.message}):(this.stripePaymentMethod=e.paymentMethod,r.resolve())})),r}createPaymentSession(e,t){let r=jQuery.Deferred(),n=e.find(".latepoint-form").serialize()+"&booking_form_page_url="+encodeURIComponent(window.location.href);var a={action:"latepoint_route_call",route_name:latepoint_helper.stripe_route_create_checkout_session,params:n,layout:"none",return_format:"json"};return jQuery.ajax({type:"post",dataType:"json",url:latepoint_helper.ajaxurl,data:a,success:e=>{"success"===e.status?(this.stripeCore.redirectToCheckout({sessionId:e.checkout_session_id}),r.resolve()):(alert(e.message),r.reject({message:e.message}))},error:function(e,t,n){r.reject({message:n})}}),r}createPaymentIntent(e,t){let r=jQuery.Deferred(),n=e.find(".latepoint-form").serialize()+"&booking_form_page_url="+encodeURIComponent(window.location.href);var a={action:"latepoint_route_call",route_name:latepoint_helper.stripe_route_create_payment_intent,params:n,layout:"none",return_format:"json"};return jQuery.ajax({type:"post",dataType:"json",url:latepoint_helper.ajaxurl,data:a,success:t=>{"success"===t.status?(e.find(".latepoint_booking_intent_key").val(t.booking_intent_key),e.find('input[name="booking[payment_token]"]').val(t.payment_intent_id),this.stripePaymentIntentSecret=t.payment_intent_secret,this.stripePaymentIntentId=t.payment_intent_id,this.stripeContinueBookingIntentURL=t.continue_booking_intent_url,latepoint_show_next_btn(e),r.resolve()):(alert(t.message),r.reject({message:t.message}))},error:function(e,t,n){r.reject({message:n})}}),r}confirmIdealPayment(e,t,r){let n=jQuery.Deferred();return this.stripeCore.confirmIdealPayment(this.stripePaymentIntentSecret,{payment_method:{ideal:this.stripeIdealBankElement},return_url:this.stripeContinueBookingIntentURL}),n}confirmCardPayment(e,t,r){let n=jQuery.Deferred();return this.stripeCore.confirmCardPayment(t,{payment_method:r.id}).then((t=>{t.error?n.reject({message:t.error.message,send_to_step:"payment"}):(e.find('input[name="booking[payment_token]"]').val(t.paymentIntent.id),n.resolve())})),n}initIdealForm(e){this.stripeIdealBankElement=this.stripeElements.create("idealBank",{value:"abn_amro",style:{base:{padding:"10px 12px",color:"#32325d",fontSize:"16px","::placeholder":{color:"#aab7c4"}}}}),this.stripeIdealBankElement.mount(e.find("#lp_ideal_bank_element")[0])}initCreditCardForm(e){let t={base:{fontFamily:latepoint_helper.body_font_family,fontSize:"14px",fontWeight:500,color:"#ffffff","::placeholder":{color:"#7d89b1"}}},r={focus:"focused",empty:"empty",invalid:"invalid"};this.stripeCardElements.cardNumber=this.stripeElements.create("cardNumber",{style:t,classes:r,placeholder:e.find("#payment_card_number").data("placeholder")}),this.stripeCardElements.cardNumber.mount(e.find("#payment_card_number")[0]),this.stripeCardElements.cardExpiry=this.stripeElements.create("cardExpiry",{style:t,classes:r,placeholder:e.find("#payment_card_expiration").data("placeholder")}),this.stripeCardElements.cardExpiry.mount(e.find("#payment_card_expiration")[0]),this.stripeCardElements.cardCvc=this.stripeElements.create("cardCvc",{style:t,classes:r,placeholder:e.find("#payment_card_cvc").data("placeholder")}),this.stripeCardElements.cardCvc.mount(e.find("#payment_card_cvc")[0]),this.registerCardElements([this.stripeCardElements.cardNumber,this.stripeCardElements.cardExpiry,this.stripeCardElements.cardCvc])}registerCardElements(e){e.forEach((function(e){e.on("change",(function(e){e.error?latepoint_show_message_inside_element(e.error.message):latepoint_hide_message_inside_element()}))}))}}let latepointPaymentsStripeAddon=new LatepointPaymentsStripeAddon(latepoint_helper.stripe_key);